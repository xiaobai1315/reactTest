{"version":3,"sources":["../../../../../jspm_packages/npm/browserify-zlib@0.1.4/test/test-zlib-random-byte-pipes.js"],"names":["Buffer","process","crypto","require","stream","Stream","util","tape","zlib","RandomReadStream","opt","call","readable","_paused","_processing","_hasher","createHash","block","total","_remaining","jitter","_opt","_process","bind","nextTick","inherits","prototype","pause","emit","resume","_hash","digest","toLowerCase","trim","Math","ceil","random","min","buf","i","update","HashStream","writable","write","c","end","t","inp","out","gzip","createGzip","gunz","createGunzip","pipe","on","ok","length","equal"],"mappings":"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","file":"test-zlib-random-byte-pipes.js","sourcesContent":["/* */ \n(function(Buffer, process) {\n  var crypto = require('crypto');\n  var stream = require('stream');\n  var Stream = stream.Stream;\n  var util = require('util');\n  var tape = require('tape');\n  var zlib = require('../src/index');\n  function RandomReadStream(opt) {\n    Stream.call(this);\n    this.readable = true;\n    this._paused = false;\n    this._processing = false;\n    this._hasher = crypto.createHash('sha1');\n    opt = opt || {};\n    opt.block = opt.block || 256 * 1024;\n    opt.total = opt.total || 256 * 1024 * 1024;\n    this._remaining = opt.total;\n    opt.jitter = opt.jitter || 1024;\n    this._opt = opt;\n    this._process = this._process.bind(this);\n    process.nextTick(this._process);\n  }\n  util.inherits(RandomReadStream, Stream);\n  RandomReadStream.prototype.pause = function() {\n    this._paused = true;\n    this.emit('pause');\n  };\n  RandomReadStream.prototype.resume = function() {\n    this._paused = false;\n    this.emit('resume');\n    this._process();\n  };\n  RandomReadStream.prototype._process = function() {\n    if (this._processing)\n      return;\n    if (this._paused)\n      return;\n    this._processing = true;\n    if (!this._remaining) {\n      this._hash = this._hasher.digest('hex').toLowerCase().trim();\n      this._processing = false;\n      this.emit('end');\n      return;\n    }\n    var block = this._opt.block;\n    var jitter = this._opt.jitter;\n    if (jitter) {\n      block += Math.ceil(Math.random() * jitter - (jitter / 2));\n    }\n    block = Math.min(block, this._remaining);\n    var buf = new Buffer(block);\n    for (var i = 0; i < block; i++) {\n      buf[i] = Math.random() * 256;\n    }\n    this._hasher.update(buf);\n    this._remaining -= block;\n    this._processing = false;\n    this.emit('data', buf);\n    process.nextTick(this._process);\n  };\n  function HashStream() {\n    Stream.call(this);\n    this.readable = this.writable = true;\n    this._hasher = crypto.createHash('sha1');\n  }\n  util.inherits(HashStream, Stream);\n  HashStream.prototype.write = function(c) {\n    this._hasher.update(c);\n    process.nextTick(this.resume.bind(this));\n    return false;\n  };\n  HashStream.prototype.resume = function() {\n    this.emit('resume');\n    process.nextTick(this.emit.bind(this, 'drain'));\n  };\n  HashStream.prototype.end = function(c) {\n    if (c) {\n      this.write(c);\n    }\n    this._hash = this._hasher.digest('hex').toLowerCase().trim();\n    this.emit('data', this._hash);\n    this.emit('end');\n  };\n  tape('random byte pipes', function(t) {\n    var inp = new RandomReadStream({\n      total: 1024,\n      block: 256,\n      jitter: 16\n    });\n    var out = new HashStream();\n    var gzip = zlib.createGzip();\n    var gunz = zlib.createGunzip();\n    inp.pipe(gzip).pipe(gunz).pipe(out);\n    inp.on('data', function(c) {\n      t.ok(c.length);\n    });\n    gzip.on('data', function(c) {\n      t.ok(c.length);\n    });\n    gunz.on('data', function(c) {\n      t.ok(c.length);\n    });\n    out.on('data', function(c) {\n      t.ok(c.length);\n    });\n    out.on('data', function(c) {\n      t.ok(c.length);\n      t.equal(c, inp._hash, 'hashes should match');\n    });\n    out.on('end', function() {\n      t.end();\n    });\n  });\n})(require('buffer').Buffer, require('process'));\n"]}